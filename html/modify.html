<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Record Modification - Younger Lab Database</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="../JavaScript/script.js"></script>
    <style>
        #passwordForm {
            margin-top: 200px;
            text-align: center;
        }
        input[type="password"], input[type="submit"], button {
            padding: 10px;
            margin: 10px;
            font-size: 16px;
            width: 100px; 
            height: 40px; 
            display: inline-block;
            vertical-align: middle;
            text-align: center;
        }
        #password {
            width: 200px; 
            height: 20px; 
            font-size: 16px; 
        }
        #protectedContent {
            display: none;
            text-align: center;
        }
    </style>
</head>
<body>
<div id="flex-container">
<div id="header-placeholder"></div>

    <div id="passwordForm">
        <form id="loginForm">
            <label for="password">Enter Password:</label><br>
            <input type="password" id="password" name="password" required><br>
            <button type="submit" value="Submit" id="submitBtn">Submit</button>
        </form>
    </div>

    <div id="protectedContent">
        <h2>Modify Existing Entries</h2>
        <br>

        <select id="formSelector" onchange="showForm()">
          <option value="Select Table" selected>Select Table</option>
          <option value="line">Mosquito Lines</option>
          <option value="member">Lab Members</option>
          <option value="sort">Sort</option>
          <option value="pass">Passage</option>
          <option value="clutch">Clutch</option>
        </select>
        
        <form id="line" class="tableFields" style="display: none;">
            <label for="l_id">Line ID: <span class="required">*</span></label>
            <input type="number" id="l_id" name="l_id" min="1" required placeholder="l_id"><br>
            <label for="yl_id">Younger Lab ID: (Read only) <span class="required">*</span></label>
            <input type="text" id="yl_id" name="yl_id" readonly required placeholder="YL ID"><br>
            <label for="short_name">Short Name: <span class="required">*</span></label>
            <input type="text" id="short_name" name="short_name" required placeholder="Short Name"><br>
            <label for="full_genotype">Full Genotype: <span class="required">*</span></label>
            <textarea type="text" id="full_genotype" name="full_genotype" required placeholder="Full Genotype"></textarea><br>
            <label for="background">Background:</label>
            <input type="text" id="background" name="background" placeholder="ORL, LVP, or other strain"><br>
            <label for="phenotype">Phenotype:</label>
            <textarea type="text" id="phenotype" name="phenotype" placeholder="Ex. bright blue eyes or not fluorescent"></textarea><br>
            <label for="phenotype_notes">Phenotype Notes:</label>
            <input type="text" id="phenotype_notes" name="phenotype_notes" placeholder="Phenotype Notes"><br>
            <label for="maintenance">Maintenance: <span class="required">*</span></label>
            <input type="text" id="maintenance" name="maintenance" required placeholder="Active or Retired"><br>
            <br>
            <label for="published">PubMed ID:</label>
            <input type="text" id="published" name="published" placeholder="PubMed ID or Unpublished"><br>
            <label for="authors">Authors:</label>
            <input type="text" id="authors" name="authors" placeholder="Ex. DeObaldia et al., 2022"><br>
            <label for="creators">Line Creators:</label>
            <textarea type="text" id="creators" name="creators" placeholder="Ex. Meg Younger, Ben Matthews, Zachary Gilbert"></textarea><br>
            <label for="genotype_notes">Genotype Notes:</label>
            <textarea type="text" id="genotype_notes" name="genotype_notes" placeholder="Genotype Notes"></textarea><br>
            <label for="dna_avail">DNA Available:</label>
            <input type="text" id="dna_avail" name="dna_avail" placeholder=""><br>
            <label for="line_notes">Notes:</label>
            <textarea type="text" id="line_notes" name="line_notes" placeholder=""></textarea><br>
            <button type="button" onclick="submitForm()">Submit</button>
        </form>

        <form id="member" class="tableFields" style="display: none;">
            <label for="m_id">Member ID: <span class="required">*</span></label>
            <input type="number" id="m_id" name="m_id" min="1" required placeholder="m_id"><br>
            <label for="f_name">First Name: <span class="required">*</span></label>
            <input type="text" id="f_name" name="f_name" required placeholder="First Name"><br>
            <label for="l_name">Last Name: <span class="required">*</span></label>
            <input type="text" id="l_name" name="l_name" required placeholder="Last Name"><br>
            <label for="lab_role">Lab Role:</label>
            <input type="text" id="lab_role" name="lab_role" placeholder="Ex. Undergraduate Researcher"><br>
            <label for="active">Active:</label>
            <input type="text" id="active" name="active" placeholder="Active or Inactive"><br>
            <button type="button" onclick="submitForm()">Submit</button>
        </form>

        <form id="sort" class="tableFields" style="display: none;">
            <label for="sort_id">Sort ID: <span class="required">*</span></label>
            <input type="number" id="sort_id" min="1" required name="sort_id"><br>
            <label for="sort_m_id">Member ID: <span class="required">*</span></label>
            <input type="number" id="sort_m_id" name="m_id" min="1" required placeholder="m_id"><br>
            <label for="sort_l_id">Line ID: <span class="required">*</span></label>
            <input type="number" id="sort_l_id" name="l_id" min="1" required placeholder="l_id"><br>
            <label for="hatch_date">Hatch Date: <span class="required">*</span></label>
            <input type="date" id="sort_hatch" required name="hatch_date"><br>
            <label for="sort_date">Sort Date: <span class="required">*</span></label>
            <input type="date" id="sort_date" required name="sort_date"><br>
            <label for="line_name">Line Name: <span class="required">*</span></label>
            <input type="text" id="line_name" required name="line_name"><br>
            <label for="marker_color">Marker Color:</label>
            <input type="text" id="marker_color" name="marker_color"><br>
            <label for="marker_location">Marker Location:</label>
            <input type="text" id="marker_location" name="marker_location"><br>
            <label for="fl_ratio">FL Ratio: <span class="required">*</span></label>
            <input type="number" id="fl_ratio" step="0.1" min="0" max="1" required name="fl_ratio"><br>
            <label for="fl_total">FL Total: <span class="required">*</span></label>
            <input type="number" id="fl_total" required name="fl_total"><br>
            <label for="sort_notes">Notes:</label>
            <input type="text" id="sort_notes" name="sort_notes"><br>
            <button type="button" onclick="submitForm()">Submit</button>
        </form>
        
        <form id="pass" class="tableFields" style="display: none;">
            <label for="pass_id">Passage ID: <span class="required">*</span></label>
            <input type="number" id="pass_id" min="1" required name="pass_id"><br>
            <label for="pass_m_id">Member ID: <span class="required">*</span></label>
            <input type="number" id="pass_m_id" name="m_id" min="1" required placeholder="m_id"><br>
            <label for="pass_l_id">Line ID: <span class="required">*</span></label>
            <input type="number" id="pass_l_id" name="l_id" min="1" required placeholder="l_id"><br>
            <label for="bc">BC: <span class="required">*</span></label>
            <input type="number" id="bc" name="bc" required placeholder="BC"><br>
            <label for="ib">IB: <span class="required">*</span></label>
            <input type="number" id="ib" name="ib" required placeholder="IB"><br>
            <label for="hatch_date">Hatch Date: <span class="required">*</span></label>
            <input type="date" id="passage_hatch" name="hatch_date" required placeholder="Hatch Date"><br>
            <label for="mating_line">Mating Line:</label>
            <input type="text" id="mating_line" name="mating_line" placeholder="Mating Line"><br>
            <label for="passage_date">Passage Date: <span class="required">*</span></label>
            <input type="date" id="passage_date" name="passage_date" required placeholder="Passage Date"><br>
            <label for="passage_date">Next Passage Date: <span class="required">*</span></label>
            <input type="date" id="next_passage" name="next_passage" required placeholder="Next Passage Date"><br>
            <button type="button" onclick="submitForm()">Submit</button>
        </form>
      
        <form id="clutch" class="tableFields" style="display: none;">
            <label for="clutch_id">Clutch ID: <span class="required">*</span></label>
            <input type="number" id="clutch_id" name="clutch_id" min="1" required placeholder="Clutch ID"><br>
            <label for="clutch_m_id">Member ID: <span class="required">*</span></label>
            <input type="number" id="clutch_m_id" name="m_id" min="1" required placeholder="m_id"><br>
            <label for="clutch_l_id">Lab ID: <span class="required">*</span></label>
            <input type="number" id="clutch_l_id" name="l_id" min="1" required placeholder="l_id"><br>
            <label for="hatch_date">Hatch Date: <span class="required">*</span></label>
            <input type="date" id="clutch_hatch" name="hatch_date" required><br>
            <label for="collection_date">Collection Date: <span class="required">*</span></label>
            <input type="date" id="collection_date" name="collection_date" required><br>
            <label for="clutch_number">Clutch Number: <span class="required">*</span></label>
            <input type="number" id="clutch_number" name="clutch_number" min="1" max="3" placeholder="Clutch Number" required><br>
            <label for="egg_papers">Egg Papers: <span class="required">*</span></label>
            <input type="number" id="egg_papers" name="egg_papers" min="1" max="10" placeholder="Egg Papers" required><br>
            <button type="button" onclick="submitForm()">Submit</button>
        </form>
    

        <div id="successMessage" style="display: none; color: green; margin-top: 10px;">Update successful!</div>
        </div>

        <div id="footer"></div>
</div>
        <script>
        
// Ensure the default option is selected on page load
document.addEventListener("DOMContentLoaded", function() {
            document.getElementById("formSelector").value = "Select Table";
        });

function showForm() {
    var selectedForm = document.getElementById("formSelector").value;
    var forms = document.getElementsByClassName("tableFields");
    for (var i = 0; i < forms.length; i++) {
        forms[i].style.display = (forms[i].id === selectedForm) ? "block" : "none";
    }
}

// Function to populate data based on ID field of the selected form
function populateFormData(formType, id) {
    var form = new FormData();
    form.append("selector", formType);
    form.append("id", id);
fetch('../cgi-bin/get.py', {
        method: 'POST',
        body: form},)
    .then(response => response.json())
    .then(data => {
        console.log("Received data:", data);
        if (data.error) {
            alert("Failed to fetch data: " + data.error);
        } else {
            for (var key in data) {
                if (data.hasOwnProperty(key)) {
                    var element = document.getElementById(key);
                    console.log("Processing key:", key);
                    if (element) {
                        console.log("Element found:", element);
                        element.value = data[key] || "";
                        console.log("Set value to:", element.value);
                    } else {
                        console.error("Element not found for key:", key);
                    }
                }
            }
        }
    })
    .catch(error => {
        console.error("Fetch error:", error);
        alert("Failed to fetch data: " + error);
    });
}

function resetForm(formId) {
            var form = document.getElementById(formId);
            if (form) {
                form.reset();  // Reset the form inputs
            }
        }

// Event listener for the input changes on the selected form
document.getElementById("formSelector").addEventListener("change", function() {
    var selectedForm = document.getElementById("formSelector").value;

    // Reset form upon switching to it
    resetForm(selectedForm);

    var idField;
    switch (selectedForm) {
        case "line":
            idField = "l_id";
            break;
        case "member":
            idField = "m_id";
            break;
        case "sort":
            idField = "sort_id";
            break;
        case "pass":  // Fixed to match the form ID
            idField = "pass_id";
            break;
        case "clutch":
            idField = "clutch_id";
            break;
        default:
            idField = null;
    }
    if (idField) {
        document.getElementById(idField).addEventListener("input", function() {
            var id = document.getElementById(idField).value;
            populateFormData(selectedForm, id);
        });
    }
});

function validateForm(formId) {
    var form = document.getElementById(formId);
    var inputs = form.querySelectorAll('input[required]');
    var isValid = true;

    inputs.forEach(function(input) {
        if (!input.value.trim()) {
            isValid = false;
            input.style.borderColor = 'red'; // Highlight empty field
        } else {
            input.style.borderColor = ''; // Reset field highlight
        }

        if (input.type === 'number') {
            var min = input.min !== '' ? parseInt(input.min, 10) : null;
            var max = input.max !== '' ? parseInt(input.max, 10) : null;
            var value = parseInt(input.value, 10);

            // Validate against min and max values if they are specified
            if ((min !== null && value < min) || (max !== null && value > max)) {
                isValid = false;
                input.style.borderColor = 'red'; // Highlight invalid number field
            }
        }
    });

    return isValid;
}

function submitForm() {
    var selectedForm = document.getElementById("formSelector").value;
    
    if (!validateForm(selectedForm)) {
        alert('Please fill in all required fields correctly.');
        return;
    }

    var formData = new FormData(document.getElementById(selectedForm));
    formData.append("selector", selectedForm);
    console.log(formData);

    fetch('../cgi-bin/update.py', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        if (data.success) {
            document.getElementById("successMessage").style.display = "block";
            document.getElementById(selectedForm).reset(); // Clear form fields after successful submission
        } else {
            alert("Failed to update database: " + data.error);
        }
    })
    .catch(error => {
        console.error("Fetch error:", error);
        alert("Failed to update database: " + error);
    });
}

        $(document).ready(function() {
            // Event listener for the login form submission
            $('#loginForm').submit(function(e) {
                e.preventDefault(); // Prevent the default form submission
                authenticate(); // Call the authenticate function
            });
        });

        function authenticate() {
            var password = $('#password').val();
            // Check if the password is correct

            $.ajax({
                    url: '../php/verify_password.php',
                    type: 'POST',
                    data: { userInput: password },
                    dataType: 'json',
                    success: function(response) {
                        if (response.match) {
                            // Show the protected content
                            $('#protectedContent').show();
                            // Hide the password form
                            $('#passwordForm').hide();
                        } else {
                            alert('Incorrect password! Please try again.');
                        }
                    },
                    error: function() {
                        $('#result').text('Error comparing the string.');
                    }
                });

            // if (password === 'pass') { // Replace 'pass' with actual password
            //     // Show the protected content
            //     $('#protectedContent').show();
            //     // Hide the password form
            //     $('#passwordForm').hide();
            // } else {
            //     // Incorrect password, show an error message
            //     alert('Incorrect password! Please try again.');
            // }
        }
        </script>
</body>
</html>

